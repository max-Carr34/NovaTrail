<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" fill="clear">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Chat</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content #content>
  <div class="chat-container">
    <!-- Loader -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Cargando mensajes...</p>
    </div>

    <!-- Error -->
    <div *ngIf="errorMsg" class="error-container">
      <ion-icon name="alert-circle-outline"></ion-icon>
      <p>{{ errorMsg }}</p>
    </div>

    <!-- Mensajes -->
    <div
      *ngFor="let msg of messages; trackBy: trackByMsgId"
      class="message-wrapper"
      [ngClass]="{ 
        'mine': msg.sender_id === myUserId,
        'theirs': msg.sender_id !== myUserId
      }"
    >
      <!-- Info del remitente (si no soy yo) -->
      <div *ngIf="msg.sender_id !== myUserId" class="sender-info">
        <div class="sender-avatar">
          <ion-icon name="person-circle-outline"></ion-icon>
        </div>
        <div class="sender-details">
          <span class="sender-name">{{ msg.sender_name }}</span>
          <span *ngIf="shouldShowSenderEmail()" class="sender-email">
            {{ getSenderEmail(msg.sender_id) }}
          </span>
        </div>
      </div>

      <!-- Burbuja del mensaje -->
      <div class="message-bubble" [ngClass]="{ 
        'my-message': msg.sender_id === myUserId,
        'other-message': msg.sender_id !== myUserId
      }">
        <div class="message-content">
          <p>{{ msg.content }}</p>
        </div>
        
        <div class="message-footer">
          <span class="message-time">{{ msg.created_at | date: 'shortTime' }}</span>
          <div *ngIf="msg.sender_id === myUserId" class="message-actions">
            <ion-button 
              fill="clear" 
              size="small" 
              color="danger" 
              (click)="confirmDelete(msg.id)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin mensajes -->
    <div *ngIf="!loading && messages.length === 0" class="empty-chat">
      <ion-icon name="chatbubbles-outline"></ion-icon>
      <p>No hay mensajes aún</p>
      <span>Inicia la conversación escribiendo un mensaje</span>
    </div>
  </div>
</ion-content>

<ion-footer>
  <!-- Bloque reply -->
  <div *ngIf="newMessage.startsWith('Respuesta a:')" class="reply-box">
    <div class="reply-text">
      {{ newMessage }}
    </div>
    <ion-button fill="clear" size="small" (click)="cancelReply()">
      <ion-icon name="close-circle" color="medium"></ion-icon>
    </ion-button>
  </div>

  <!-- Input -->
  <div class="input-container">
    <div class="input-wrapper">
      <ion-textarea
        [(ngModel)]="newMessage"
        placeholder="Escribe un mensaje..."
        rows="1"
        autoGrow="true"
        maxlength="500"
        (keydown.enter)="onEnterPress($event)"
      ></ion-textarea>
      
      <ion-button 
        color="primary" 
        fill="solid"
        shape="round"
        [disabled]="!newMessage.trim()"
        (click)="sendMessage()"
      >
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
    
    <div class="char-counter" *ngIf="newMessage.length > 400">
      {{ newMessage.length }}/500
    </div>
  </div>
</ion-footer>
